<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran 9.0//EN"
        "https://aspectran.com/dtd/aspectran-9.dtd">
<aspectran>

    <description>
        Aspectran configuration for setting up an Undertow server.
    </description>

    <environment>
        <property name="tow.server.listener.http.port" valueType="int">8081</property>
        <property name="tow.server.listener.http.host">0.0.0.0</property>
        <property name="tow.server.baseDir">/webapps/root</property>
    </environment>

    <bean id="tow.server" class="com.aspectran.undertow.server.DefaultTowServer">
        <property name="httpListeners" type="array">
            <bean class="com.aspectran.undertow.server.HttpListenerConfig">
                <property name="port" valueType="int">%{tow.server.listener.http.port}</property>
                <property name="host">%{tow.server.listener.http.host}</property>
            </bean>
        </property>
        <property name="serverOptions">
            <bean class="com.aspectran.undertow.server.TowOptions">
                <property name="decodeUrl" valueType="boolean">true</property>
                <property name="urlCharset">UTF-8</property>
            </bean>
        </property>
        <property name="workerOptions">
            <bean class="com.aspectran.undertow.server.TowOptions">
                <property name="workerName">TOW</property>
            </bean>
        </property>
        <property name="requestHandlerFactory">
            <bean class="com.aspectran.undertow.server.handler.LightRequestHandlerFactory">
                <property name="resourceManager">
                    <bean class="com.aspectran.undertow.server.handler.resource.TowResourceManager">
                        <property name="base">%{tow.server.baseDir}</property>
                    </bean>
                </property>
                <property name="sessionManager">#{tow.server.sessionManager}</property>
                <property name="sessionConfig">
                    <bean class="io.undertow.server.session.SessionCookieConfig"/>
                </property>
                <property name="handlerChainWrappers" type="array">
                    <value>#{tow.server.handler.accessLogHandlerWrapper}</value>
                    <value>#{tow.server.handler.encodingHandlerWrapper}</value>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="tow.server.sessionManager"
          class="com.aspectran.undertow.server.session.TowSessionManager"
          scope="prototype">
        <property name="sessionManagerConfig">
            <bean class="com.aspectran.core.context.config.SessionManagerConfig">
                <argument>
                    workerName: n0
                    maxActiveSessions: 9999
                    maxIdleSeconds: 1800
                    evictionIdleSeconds: 900
                    scavengingIntervalSeconds: 600
                    clusterEnabled: false
                </argument>
            </bean>
        </property>
        <property name="sessionStore">
            <bean class="com.aspectran.core.component.session.FileSessionStoreFactoryBean">
                <property name="storeDir">/work/_sessions/tow</property>
            </bean>
        </property>
    </bean>

    <bean id="tow.server.handler.encodingHandlerWrapper"
          class="com.aspectran.undertow.server.handler.encoding.EncodingHandlerWrapper"
          scope="prototype">
        <property name="encodingProviders" type="array">
            <value>gzip</value>
        </property>
        <property name="encodingPredicates" type="array">
            <bean class="com.aspectran.undertow.server.handler.encoding.ContentEncodingPredicates">
                <property name="mediaTypes" type="array">
                    <value>text/html</value>
                    <value>text/css</value>
                    <value>text/javascript</value>
                    <value>application/javascript</value>
                </property>
            </bean>
            <bean class="com.aspectran.undertow.server.handler.encoding.ContentEncodingPredicates">
                <property name="contentSizeLargerThan" valueType="long">32</property>
                <property name="mediaTypes" type="array">
                    <value>text/xml</value>
                    <value>text/plain</value>
                    <value>application/json</value>
                    <value>application/xml</value>
                    <value>application/apon</value>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="tow.server.handler.accessLogHandlerWrapper"
          class="com.aspectran.undertow.server.handler.accesslog.AccessLogHandlerWrapper"
          scope="prototype">
        <property name="formatString" tokenize="false">%t %a %{i,X-Forwarded-For} %{c,JSESSIONID} "%r" %s %b "%{i,Referer}" "%{i,User-Agent}"</property>
        <property name="category">io.undertow.accesslog</property>
    </bean>

</aspectran>
