<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran Configuration 6.0//EN"
        "http://aspectran.github.io/dtd/aspectran-6.dtd">
<aspectran>

    <description>
        An Aspectran configuration for Undertow Server.
    </description>

    <environment>
        <properties>
            <item name="tow.server.startup" valueType="boolean">true</item>
            <item name="tow.server.listener-1.port" valueType="int">8080</item>
            <item name="tow.server.listener-1.host">0.0.0.0</item>
        </properties>
    </environment>

    <bean id="tow.server" class="com.aspectran.undertow.server.TowServer">
        <properties>
            <item name="autoStart">%{tow.server.startup}</item>
            <item name="listeners" type="array">
                <value>
                    <bean class="io.undertow.Undertow$ListenerBuilder">
                        <properties>
                            <item name="type">#{field:io.undertow.Undertow$ListenerType^HTTP}</item>
                            <item name="port" valueType="int">%{tow.server.listener-1.port}</item>
                            <item name="host">%{tow.server.listener-1.host}</item>
                        </properties>
                    </bean>
                </value>
            </item>
            <item name="handler">#{tow.accessLogHandler}</item>
        </properties>
    </bean>

    <bean id="tow.accessLogHandler" class="com.aspectran.undertow.server.accesslog.AccessLogHandlerFactoryBean">
        <properties>
            <item name="handler">#{tow.encodingHandler}</item>
            <item name="formatString">combined</item>
            <item name="category">io.undertow.accesslog</item>
        </properties>
    </bean>

    <bean id="tow.encodingHandler" class="com.aspectran.undertow.server.encoding.EncodingHandlerFactoryBean">
        <properties>
            <item name="handler">#{tow.httpHandler}</item>
            <item name="contentEncodingProviders" type="array">
                <value>gzip</value>
                <value>deflate</value>
            </item>
        </properties>
    </bean>

    <bean id="tow.httpHandler" class="com.aspectran.undertow.server.http.DefaultHttpHandler">
        <arguments>
            <item>#{tow.resourceManager}</item>
        </arguments>
        <properties>
            <item name="staticResourceHandler">
                <bean class="com.aspectran.undertow.server.resource.StaticResourceHandler" initMethod="autoDetect">
                    <arguments>
                        <item>#{tow.resourceManager}</item>
                    </arguments>
                    <properties>
                        <item name="resourcePathPatterns">
                            <bean class="com.aspectran.undertow.server.resource.ResourcePathPatterns">
                                <arguments>
                                    <item>
                                        +: /assets/**
                                        -: /assets/aaa.bbb
                                    </item>
                                </arguments>
                            </bean>
                        </item>
                    </properties>
                </bean>
            </item>
            <item name="sessionManager">#{tow.sessionManger}</item>
            <item name="sessionConfig">
                <bean class="io.undertow.server.session.SessionCookieConfig"/>
            </item>
        </properties>
    </bean>

    <bean id="tow.resourceManager" class="com.aspectran.undertow.server.resource.TowResourceManager">
        <properties>
            <item name="base">/webapps/root</item>
        </properties>
    </bean>

    <bean id="tow.sessionManger" class="com.aspectran.undertow.server.session.TowSessionManager" scope="prototype">
        <properties>
            <item name="sessionManagerConfig">
                <bean class="com.aspectran.core.context.config.SessionManagerConfig">
                    <arguments>
                        <item>
                            workerName: node0
                            maxSessions: 99999
                            maxIdleSeconds: 1800
                            evictionIdleSeconds: 900
                            scavengingIntervalSeconds: 600
                            storeType: file
                            fileStore: {
                                storeDir: /temp/sessions/tow
                                deleteUnrestorableFiles: true
                            }
                            startup: true
                        </item>
                    </arguments>
                </bean>
            </item>
        </properties>
    </bean>

</aspectran>